<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles/style.css">
  <title>AnimeTracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="scripts/script.js"></script>
  <script>
    if (sessionStorage.getItem("username") == null || sessionStorage.getItem("username") == "undefined") {
        window.location = "login.html";
    }
  </script>
</head>
<body>
  <!-- Header stylisé -->
  <header>
    <h1 id="h1"></h1>
    <script>
        document.getElementById('h1').innerHTML = sessionStorage.getItem('username') + "'s Anime List";
    </script>
    <div id="comptes">
        <h5 id="cptcurrent">0 En Cours</h5>
        <h5 id="cptfinish">0/0 Terminés</h5>
    </div>
  </header>
  

  <main>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Image</th>
            <th>Nom</th>
            <th>Progression</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- exemples -->
          <tr class="letter-separator">
            <td colspan="5">D</td>
        </tr>
          <tr>
            <td><img src="https://cdn.myanimelist.net/images/anime/5/17407.jpg" alt="Death Note"></td>
            <td>Death Note</td>
            <td>1 saison (37)</td>
            <td class="status finished">Terminé</td>
            <td>
              <button class="next-ep" disabled>➡️</button>
              <button class="edit">⚙️</button>
            </td>
          </tr>
          <tr class="letter-separator">
            <td colspan="5">N</td>
          </tr>
          <tr>
            <td><img src="https://cdn.myanimelist.net/images/anime/10/47347.jpg" alt="Naruto Shippuden"></td>
            <td>Naruto Shippuden</td>
            <td>Saison 20 épisode 500</td>
            <td class="status watching">En cours</td>
            <td>
              <button class="next-ep">➡️</button>
              <button class="edit">⚙️</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Bouton flottant -->
  <button class="fab" id="openForm">＋</button>
  <button class="fab" id="LogOut" onclick="LogOut();">⍈</button>

    <!-- Formulaire flottant d'ajout -->
    <div class="modal" id="animeForm">
        <div class="modal-content wide">
            <h2 class="police">Ajouter un Anime</h2>
            <form class="form-two-col">
            <!-- Colonne gauche (titres) -->
                <div class="form-col left">
                    <div class="form-group">
                        <label>Rechercher</label>
                        <input type="text" id="titreSearch" placeholder="Rechercher">
                    </div>
                    <div class="form-group" style="margin-top: -5%; margin-left: 20%; color: yellow; display: none;" id="warninginlist">
                        <p>Cet anime est déjà dans la liste</p>
                    </div>
                    <div class="form-group">
                        <input type="hidden" id="imgURL" name="imgURL">
                        <div style="margin-top:10px; text-align:center;">
                            <img src="" id="previewImg" alt="Preview" style="zoom: 1000%; max-width:100%; border-radius:8px; display:none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nom (Kanji)</label>
                        <input type="text" id="titrenatif" placeholder="Nom Natif">
                    </div>
                    <div class="form-group">
                        <label>Nom (Romaji)</label>
                        <input type="text" id="titrermji" placeholder="Nom Romaji">
                    </div>
                    <div class="form-group">
                        <label>Nom (EN)</label>
                        <input type="text" id="titreen" placeholder="Nom Anglais">
                    </div>
                    <!-- <div class="form-group">
                        <label>Nom (FR)</label>
                        <input type="text" placeholder="Nom français">
                    </div> -->
                </div>

                <!-- Colonne droite (infos + saisons dynamiques) -->
                <div class="form-col right">
                    <div class="form-group">
                    <label>Langue préférée</label>
                    <select id="languepref">
                        <option value="EN" selected>Anglais</option>
                        <option value="NA">Natif</option>
                        <!-- <option value="FR">Français</option> -->
                    </select>
                    </div>

                    <div class="form-group">
                    <label>Statut</label>
                    <select id="statut" onchange="StatutChange(this.value);">
                        <option value="toview" selected>À voir</option>
                        <option value="watching">En cours</option>
                        <option value="finished">Terminé</option>
                        <option value="waiting">En attente</option>
                        <option value="dropped">Abandonné</option>
                        <option value="restart">Recommencer</option>
                    </select>
                    </div>

                    <div class="form-group-currentvalues" id="currentsvalues">
                        <div>
                            <label>Saison en cours</label>
                            <input type="number" id="currentseason" min="1" value="">
                        </div>
                        <div>
                            <label>Épisode en cours</label>
                            <input type="number" id="currentep" min="1" value="">
                        </div>
                    </div>

                    <div class="form-group">
                        <!-- Switch -->
                        <label class="switch">
                            <input type="checkbox" id="checkboxsf" onchange="sfChange();">
                            <span class="slider"></span>
                            <span class="labels" data-off="Série" data-on="Film"></span>
                        </label>
                    </div>

                    <div class="form-group form-group-duree" id="divduree">
                        <label>Durée</label>
                        <input type="time" id="duree" min="0" value="00:00">
                    </div>

                    <div class="form-group" id="divnbsaison">
                        <label>Nombre de saisons</label>
                        <input type="number" id="seasonCount" min="1" value="">
                    </div>

                    <!-- Ici seront générés dynamiquement les inputs -->
                    <div class="form-group" id="seasonInputs">
                        <!-- <label>Épisodes / saisons</label> -->
                        <!-- <div class="season-line">
                            <span>Saison 1 :</span>
                            <input type="number" min="1" value="">
                        </div> -->
                    </div>
                </div>
            </form>

            <div class="form-actions">
                <button type="button" class="cancel">Annuler</button>
                <button type="submit" id="addanime" onclick="addBtnClick();" class="add">Ajouter</button>
            </div>
        </div>
    </div>  



    <!-- Formulaire flottant de modif -->
    <div class="modal" id="animeForm-edit">
        <div class="modal-content wide">
            <h2 class="police">Modifier</h2>
            <form class="form-two-col">
            <!-- Colonne gauche (titres) -->
                <div class="form-col left">
                    <div class="form-group">
                        <input type="hidden" id="imgURL-edit" name="imgURL">
                        <input type="hidden" id="rowid" name="rowid">
                        <div style="margin-top:10px; text-align:center;">
                            <img src="" id="previewImg-edit" alt="Preview" style="zoom: 1000%; max-width:100%; border-radius:8px; display:none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nom (Kanji)</label>
                        <input type="text" id="titrenatif-edit" placeholder="Nom Natif">
                    </div>
                    <div class="form-group">
                        <label>Nom (Romaji)</label>
                        <input type="text" id="titrermji-edit" placeholder="Nom Romaji">
                    </div>
                    <div class="form-group">
                        <label>Nom (EN)</label>
                        <input type="text" id="titreen-edit" placeholder="Nom Anglais">
                    </div>
                    <!-- <div class="form-group">
                        <label>Nom (FR)</label>
                        <input type="text" placeholder="Nom français">
                    </div> -->
                </div>

                <!-- Colonne droite (infos + saisons dynamiques) -->
                <div class="form-col right">
                    <div class="form-group">
                    <label>Langue préférée</label>
                    <select id="languepref-edit">
                        <option value="EN" selected>Anglais</option>
                        <option value="NA">Natif</option>
                        <!-- <option value="FR">Français</option> -->
                    </select>
                    </div>

                    <div class="form-group">
                    <label>Statut</label>
                    <select id="statut-edit" onchange="StatutChange(this.value);">
                        <option value="toview" selected>À voir</option>
                        <option value="watching">En cours</option>
                        <option value="finished">Terminé</option>
                        <option value="waiting">En attente</option>
                        <option value="dropped">Abandonné</option>
                        <option value="restart">Recommencer</option>
                    </select>
                    </div>

                    <div class="form-group-currentvalues" id="currentsvalues-edit">
                        <div>
                            <label>Saison en cours</label>
                            <input type="number" id="currentseason-edit" min="1" value="">
                        </div>
                        <div>
                            <label>Épisode en cours</label>
                            <input type="number" id="currentep-edit" min="1" value="">
                        </div>
                    </div>

                    <div class="form-group">
                        <!-- Switch -->
                        <label class="switch">
                            <input type="checkbox" id="checkboxsf-edit" onchange="sfChange();">
                            <span class="slider"></span>
                            <span class="labels" data-off="Série" data-on="Film"></span>
                        </label>
                    </div>

                    <div class="form-group form-group-duree" id="divduree-edit">
                        <label>Durée</label>
                        <input type="time" id="duree-edit" min="0" value="00:00">
                    </div>

                    <div class="form-group" id="divnbsaison-edit">
                        <label>Nombre de saisons</label>
                        <input type="number" id="seasonCount-edit" min="1" value="">
                    </div>

                    <!-- Ici seront générés dynamiquement les inputs -->
                    <div class="form-group" id="seasonInputs-edit">
                        <!-- <label>Épisodes / saisons</label> -->
                        <!-- <div class="season-line">
                            <span>Saison 1 :</span>
                            <input type="number" min="1" value="">
                        </div> -->
                    </div>
                </div>
            </form>

            <div class="form-actions">
                <button type="button" class="delete" onclick="delBtnClick();">Supprimer</button>
                <button type="button" class="cancel cancel2">Annuler</button>
                <button type="submit" id="editanime" onclick="editBtnClick();" class="add">Modifier</button>
            </div>
        </div>
    </div>  

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://fwdqeibadcyxcvdcuqjt.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3ZHFlaWJhZGN5eGN2ZGN1cWp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MjU0ODIsImV4cCI6MjA3MTEwMTQ4Mn0.CAUlJIATUnRTsYig4THdEZiwBXS72CJxDCO-oBqj-pQ';
  const Supabase = supabase.createClient(supabaseUrl, supabaseKey);
</script>
<script>
  const openBtn = document.getElementById("openForm");
  const modal = document.getElementById("animeForm");
  const modal2 = document.getElementById("animeForm-edit");
  const cancelBtn = document.querySelector(".cancel");
  const cancelBtn2 = document.querySelector(".cancel2");

  openBtn.onclick = () => modal.classList.add("show");
  cancelBtn.onclick = () => removeModal();

  cancelBtn2.onclick = () => removeModal2();

  function removeModal(){
    modal.classList.remove("show");
    clearModal();
  }

  function removeModal2(){
    modal2.classList.remove("show");
    // clearModal2();
  }

  // --- Gestion dynamique des saisons ---
  const seasonCountInput = document.getElementById("seasonCount");
  const seasonInputsDiv = document.getElementById("seasonInputs");

  function updateSeasonInputs() {
    const count = parseInt(seasonCountInput.value) || 0;
    seasonInputsDiv.innerHTML = "";

    if (count > 0) {
        seasonInputsDiv.innerHTML = "<label>Épisodes / saisons</label>";
        for (let i = 1; i <= count; i++) {
        const div = document.createElement("div");
        div.classList.add("season-line");
        div.innerHTML = `
            <span>Saison ${i} :</span>
            <input type="number" min="1" value="">
        `;
        seasonInputsDiv.appendChild(div);
        }
    }
  }
  seasonCountInput.addEventListener("input", updateSeasonInputs);
  
  // --- Gestion dynamique des saisons ---
  const seasonCountInput2 = document.getElementById("seasonCount-edit");
  const seasonInputsDiv2 = document.getElementById("seasonInputs-edit");

  function updateSeasonInputs2() {
    const count = parseInt(seasonCountInput2.value) || 0;
    seasonInputsDiv2.innerHTML = "";

    if (count > 0) {
        seasonInputsDiv2.innerHTML = "<label>Épisodes / saisons</label>";
        for (let i = 1; i <= count; i++) {
        const div = document.createElement("div");
        div.classList.add("season-line");
        div.innerHTML = `
            <span>Saison ${i} :</span>
            <input type="number" min="1" value="">
        `;
        seasonInputsDiv2.appendChild(div);
        }
    }
  }
  seasonCountInput2.addEventListener("input", updateSeasonInputs2);
</script>
<script>
    const titreSearch = document.getElementById('titreSearch');
    const imgPreview = document.getElementById('previewImg');
    const imgURL = document.getElementById('imgURL');
    const titrenatif = document.getElementById('titrenatif');
    const titrermji = document.getElementById('titrermji');
    const titreen = document.getElementById('titreen');
    const checkboxsf = document.getElementById('checkboxsf');
    let idanime = "";

    let timeout = null;

    titreSearch.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const query = `
            query ($search: String) {
                Media(search: $search, type: ANIME) {
                    id
                    title {
                        romaji
                        english
                        native
                    }
                    coverImage {
                        large
                    }
                    description
                }
            }`;
            const variables = {
            search: titreSearch.value.trim()
            };

            fetch('https://graphql.anilist.co', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    variables: variables
                })
            })
            .then(res => res.json())
            .then(data => {
                // Traitement des données reçues
                if (data.data && data.data.Media) {
                    const anime = data.data.Media;
                    // Vous pouvez maintenant utiliser les informations de l'anime
                    // Par exemple, afficher l'image et le titre
                    if (anime.coverImage && anime.coverImage.large) {
                        imgPreview.src = anime.coverImage.large;
                        imgURL.value = anime.coverImage.large;
                        console.log(imgURL.value);
                        imgPreview.style.display = 'block';
                        titrenatif.value = anime.title.native;
                        titrermji.value = anime.title.romaji;
                        titreen.value = anime.title.english;
                        idanime = String(anime.id);
                        if (anime.title.english == null) {
                            document.getElementById('languepref').value = 'NA';
                        }
                        else{
                            document.getElementById('languepref').value = 'EN';
                        }
                        getIfAnimeExist(idanime);
                    } else {
                        imgPreview.style.display = 'none';
                        titrenatif.value = "";
                        titrermji.value = "";
                        titreen.value = "";
                        getIfAnimeExist(0);
                    }

                } else {
                    imgPreview.style.display = 'none';
                    imgURL.value = '';
                    titrenatif.value = "";
                    titrermji.value = "";
                    titreen.value = "";
                    getIfAnimeExist(0);
                }
            })
            .catch(err => {
                console.error('Erreur lors de l\'appel à l\'API AniList:', err);
                imgPreview.style.display = 'none';
                imgURL.value = '';
                titrenatif.value = "";
                titrermji.value = "";
                titreen.value = "";
                getIfAnimeExist(0);
            });
        }, 500); // délai pour éviter trop de requêtes
    });
</script>
<script>
    function addBtnClick () {
        let urlimg = document.getElementById('imgURL').value;
        let nomnative = document.getElementById('titrenatif').value;
        let nomromaji = document.getElementById('titrermji').value;
        let nomenglish = document.getElementById('titreen').value;
        let languepref = document.getElementById('languepref').value;
        let statut = document.getElementById('statut').value;
        let nbsaisons = document.getElementById('seasonCount').value;
        let saisonencours = document.getElementById('currentseason').value;
        let epencours = document.getElementById('currentep').value;
        let checkboxsf = document.getElementById('checkboxsf').checked;
        let duree = document.getElementById('duree').value;
        const divs = document.querySelectorAll('.season-line');

        let listep = [];
        let detailsepsaison = "";

        divs.forEach(div => {
            const input = div.querySelector('input');
            
            const valeurInput = input.value;
            
            listep.push(valeurInput);

            if (detailsepsaison != "") {
                detailsepsaison += ",";
            }
            detailsepsaison += String(valeurInput);

            input.value = 0;
        });

        let count = 0;
        for (let i = 0; i < listep.length; i++) {
            count += parseInt(listep[i]);
        }

        let nbepisodes = count;


        if (saisonencours == "") {
            saisonencours = 1;
        }
        if (epencours == "") {
            epencours = 1;
        }

        // console.log("idanime : " + idanime);
        // console.log("urlimg : " + urlimg); 
        // console.log("nomnative : " + nomnative); 
        // console.log("nomromaji : " + nomromaji); 
        // console.log("nomenglish : " + nomenglish); 
        // console.log("languepref : " + languepref); 
        // console.log("statut : " + statut); 
        // console.log("nbsaisons : " + nbsaisons); 
        // console.log("detailsepsaison : " + detailsepsaison); 
        // console.log("nbepisodes : " + nbepisodes);
        // console.log("saisonencours : " + saisonencours);
        // console.log("epencours : " + epencours);
        // console.log("checkboxsf : " + checkboxsf);
        // console.log("duree : " + duree);

        addAnime(idanime, urlimg, nomnative, nomromaji, nomenglish, languepref, statut, nbsaisons, nbepisodes, saisonencours, epencours, detailsepsaison, checkboxsf, duree);

        console.log(detailsepsaison);

        
        modal.classList.remove("show")
        
        let seasonInputs = document.getElementById('seasonInputs');
        seasonInputs.innerHTML = '';
        updateSeasonInputs();

        let timeoutTable = null;
        clearTimeout(timeoutTable);
        timeoutTable = setTimeout(() => {
            clearModal();
            sfChange();
        }, 500);
    };
</script>
<script>
    function editBtnClick() {
        let rowid = document.getElementById('rowid').value;
        let urlimg = document.getElementById('imgURL-edit').value;
        let nomnative = document.getElementById('titrenatif-edit').value;
        let nomromaji = document.getElementById('titrermji-edit').value;
        let nomenglish = document.getElementById('titreen-edit').value;
        let languepref = document.getElementById('languepref-edit').value;
        let statut = document.getElementById('statut-edit').value;
        let nbsaisons = document.getElementById('seasonCount-edit').value;
        let saisonencours = document.getElementById('currentseason-edit').value;
        let epencours = document.getElementById('currentep-edit').value;
        let checkboxsf = document.getElementById('checkboxsf-edit').checked;
        let duree = document.getElementById('duree-edit').value;
        const divs = document.querySelectorAll('.season-line');

        let listep = [];
        let detailsepsaison = "";

        divs.forEach(div => {
            const input = div.querySelector('input');
            
            const valeurInput = input.value;
            
            listep.push(valeurInput);

            if (detailsepsaison != "") {
                detailsepsaison += ",";
            }
            detailsepsaison += String(valeurInput);
        });

        let count = 0;
        for (let i = 0; i < listep.length; i++) {
            count += parseInt(listep[i]);
        }

        let nbepisodes = count;


        if (saisonencours == "") {
            saisonencours = 1;
        }
        if (epencours == "") {
            epencours = 1;
        }
        
        updaterow(rowid, nomnative, nomromaji, nomenglish, languepref, statut, nbsaisons, nbepisodes, saisonencours, epencours, detailsepsaison, checkboxsf, duree)

        modal2.classList.remove("show")

        let timeoutTable = null;
        clearTimeout(timeoutTable);
        timeoutTable = setTimeout(() => {
            selectList();
            clearModal2();
            sfChange();
        }, 500);
    }

    function delBtnClick() {
        let nomromaji = document.getElementById('titrermji-edit').value;
        let nomenglish = document.getElementById('titreen-edit').value;
        let languepref = document.getElementById('languepref-edit').value;
        let rowid = document.getElementById('rowid').value;

        let nomanime = nomenglish;
        if (languepref == 'NA') {
            nomanime = nomromaji;
        }
        if (confirm('Supprimer ' + nomanime + ' ?')) {
            deleteRow(rowid);
            modal2.classList.remove("show")

            let timeoutTable = null;
            clearTimeout(timeoutTable);
            timeoutTable = setTimeout(() => {
                selectList();
                clearModal2();
                sfChange();
            }, 500);
        }
    }
</script>
<script>
    function LogOut() {
        sessionStorage.clear();
        window.location = "login.html";
    }

    function StatutChange(newval) {
        if (newval == "watching" || newval == "waiting" || newval == "dropped") {
            document.getElementById('currentsvalues').style.display = 'flex';
            document.getElementById('currentsvalues-edit').style.display = 'flex';
        } else {
            document.getElementById('currentsvalues').style.display = 'none';
            document.getElementById('currentseason').value = null;
            document.getElementById('currentep').value = null;
            document.getElementById('currentsvalues-edit').style.display = 'none';
            document.getElementById('currentseason-edit').value = null;
            document.getElementById('currentep-edit').value = null;
        }
    }

    function sfChange() {
        if (document.getElementById('checkboxsf').checked) {
            document.getElementById('divduree').style.display = 'flex';
            document.getElementById('divnbsaison').style.display = 'none';
            document.getElementById('seasonCount').value = "";
            updateSeasonInputs()
        }
        else{
            document.getElementById('divduree').style.display = 'none';
            document.getElementById('divnbsaison').style.display = 'flex';
        }

        if (document.getElementById('checkboxsf-edit').checked) {
            document.getElementById('divduree-edit').style.display = 'flex';
            document.getElementById('divnbsaison-edit').style.display = 'none';
            document.getElementById('seasonCount-edit').value = 0;
            updateSeasonInputs2()
            document.getElementById('seasonCount-edit').value = '';
        }
        else{
            document.getElementById('divduree-edit').style.display = 'none';
            document.getElementById('divnbsaison-edit').style.display = 'flex';
        }
    }
</script>
<script>
    selectList();
    printCounts();
</script>
</body>
</html>